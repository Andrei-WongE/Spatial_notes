<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.38">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Andrei Wong">
<meta name="dcterms.date" content="2022-06-01">
<title>Spatial data: OSM_Notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><style>html{ scroll-behavior: smooth; }</style>
<script async="" src="https://hypothes.is/embed.js"></script><script src="index_files/libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="index_files/libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="index_files/libs/datatables-binding-0.23/datatables.js"></script><script src="index_files/libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><link href="index_files/libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="index_files/libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="index_files/libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script><link href="index_files/libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="index_files/libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="index_files/libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="index_files/libs/selectize-0.12.0/selectize.min.js"></script><link href="index_files/libs/dt-plugin-searchhighlight-1.11.3/source.css" rel="stylesheet">
<script src="index_files/libs/dt-plugin-searchhighlight-1.11.3/jquery.highlight.js"></script><script src="index_files/libs/dt-plugin-searchhighlight-1.11.3/source.min.js"></script><link href="index_files/libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="index_files/libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><link rel="stylesheet" href="headers.css">
</head>
<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#set-up" id="toc-set-up" class="nav-link active" data-scroll-target="#set-up"> <span class="header-section-number">1</span> Set-up</a></li>
  <li><a href="#obtaining-data" id="toc-obtaining-data" class="nav-link" data-scroll-target="#obtaining-data"> <span class="header-section-number">2</span> Obtaining data</a></li>
  <li><a href="#obtaining-boundaries" id="toc-obtaining-boundaries" class="nav-link" data-scroll-target="#obtaining-boundaries"> <span class="header-section-number">3</span> Obtaining boundaries</a></li>
  <li>
<a href="#adding-data-streets-buildings-and-population-density" id="toc-adding-data-streets-buildings-and-population-density" class="nav-link" data-scroll-target="#adding-data-streets-buildings-and-population-density"> <span class="header-section-number">4</span> Adding data: Streets, buildings, and population density</a>
  <ul class="collapse">
<li><a href="#tilting-sf-objects" id="toc-tilting-sf-objects" class="nav-link" data-scroll-target="#tilting-sf-objects"> <span class="header-section-number">4.1</span> Tilting sf objects</a></li>
  </ul>
</li>
  <li><a href="#visualize-data-with-ggplot2-tmap-leaflet-and-sfmap" id="toc-visualize-data-with-ggplot2-tmap-leaflet-and-sfmap" class="nav-link" data-scroll-target="#visualize-data-with-ggplot2-tmap-leaflet-and-sfmap"> <span class="header-section-number">5</span> Visualize data with ggplot2, tmap, leaflet and sfmap</a></li>
  <li><a href="#appendix" id="toc-appendix" class="nav-link" data-scroll-target="#appendix"> <span class="header-section-number">6</span> Appendix</a></li>
  </ul></nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">Spatial data: OSM_Notes</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p><a href="https://github.com/Andrei-WongE">Andrei Wong</a> </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 1, 2022</p>
    </div>
  </div>
    
  </div>
  

</header><section id="set-up" class="level1" data-number="1"><h1 data-number="1">
<span class="header-section-number">1</span> Set-up</h1>
<div class="cell" data-hash="index_cache/html/timestamp-setup_f653fc10030d8e5f64159993ab70f009">

</div>
<p>Note updated on 2022-08-10 from index.rmarkdown with knitr version 1.39.</p>
<p>::: {.callout-note collapse = “false”} ## General set-up of the program.</p>
<p>These notes make use of the following R packages and general set-up. :::</p>
<div class="cell" data-hash="index_cache/html/set-up_e2ae52799f5b117a009a83ce8e97b559">
<details><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R">  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">tidyverse</span> 
                 ,<span class="va">tidylog</span>
                 ,<span class="va">Cairo</span>
                 ,<span class="va">here</span>
                 ,<span class="va">dplyr</span>
                 ,<span class="va">crsuggest</span>  <span class="co"># Suggest CRS information for spatial data</span>
                 ,<span class="va">ggplot2</span>
                 ,<span class="va">ggnewscale</span> <span class="co"># For multiple fill and colour scales in ggplot2</span>
                 ,<span class="va">ggsn</span>       <span class="co"># North Symbols and Scale Bars for Maps</span>
                 ,<span class="va">osmdata</span>    <span class="co"># For downloading and using data from OSM</span>
                 ,<span class="va">sf</span>         <span class="co"># DONT'T FORGET uses the s2geometry library</span>
                 ,<span class="va">knitr</span>
                 ,<span class="va">rvest</span>      <span class="co"># For Web scrapping</span>
                 ,<span class="va">DT</span>         <span class="co"># R interface to the JavaScript library DataTables</span>
                 ,<span class="va">downlit</span>    <span class="co"># For syntax highlighting and automatic linking</span>
                 ,<span class="va">git2r</span>      <span class="co"># Provides access to 'Git' repositories</span>
                 ,<span class="va">xfun</span>       <span class="co"># For alternative Session Info</span>
                 <span class="op">)</span>
  
  <span class="co">#pacman::p_update()         # Update out-of-date packages</span>

  <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>scipen <span class="op">=</span> <span class="fl">100</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>             <span class="co"># Prefer non-scientific notation</span>
  
  <span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span> dev       <span class="op">=</span> <span class="st">"CairoPNG"</span> <span class="co"># Alpha transparency in png</span>
                        ,fig.path  <span class="op">=</span> <span class="st">"Figs/"</span>
                        ,dpi       <span class="op">=</span> <span class="fl">600</span>
                        ,fig.width <span class="op">=</span> <span class="fl">10</span>
                        ,fig.hight <span class="op">=</span> <span class="fl">12</span>
  <span class="co"># Automatically formatting code using styler</span>
                        ,tidy      <span class="op">=</span> <span class="st">"styler"</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="obtaining-data" class="level1" data-number="2"><h1 data-number="2">
<span class="header-section-number">2</span> Obtaining data</h1>
<p>Using <code>osmdata</code> package you can download data from <a href="https://www.openstreetmap.org/about">OSM</a>. Consider that this package provides access to vector data while the <code>OpenStreetMap</code> package to <mark>raster tiles</mark>. For more information about <code>OpenStreetMap</code> see <a href="http://blog.fellstat.com/?cat=15">here</a>.</p>
<div class="cell" data-hash="index_cache/html/data_6e6e1cf978a3990000adb3974aeab4af">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">Lima</span> <span class="op">&lt;-</span>
  <span class="fu">getbb</span><span class="op">(</span><span class="st">"Lima Metropolitana"</span><span class="op">)</span> |&gt; <span class="co"># obtaining boundaries</span>
  <span class="fu">opq</span><span class="op">(</span>timeout <span class="op">=</span> <span class="fl">20</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span> |&gt; <span class="co"># overpass query</span>
  <span class="fu">add_osm_feature</span><span class="op">(</span> <span class="co"># retrieve administrative boundaries</span>
    key <span class="op">=</span> <span class="st">"admin_level"</span>,
    value <span class="op">=</span> <span class="st">"5"</span> <span class="co"># boundary box at the met level</span>
  <span class="op">)</span> |&gt;
  <span class="fu">osmdata_sf</span><span class="op">(</span><span class="op">)</span> <span class="co"># import as an sf object</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Dowloaded data timestamp: [ mié. 4 Ago 2022 20:48:07 ].</p>
</section><section id="obtaining-boundaries" class="level1 page-columns page-full" data-number="3"><h1 data-number="3">
<span class="header-section-number">3</span> Obtaining boundaries</h1>
<div class="cell" data-hash="index_cache/html/boundaries_0920a48cc7d847d064f1c70d6715f3e5">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">Lima_multipolygons</span> <span class="op">&lt;-</span> <span class="va">Lima</span> |&gt;
  <span class="op">(</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">osm_multipolygons</span><span class="op">(</span><span class="va">x</span>, <span class="va">x</span><span class="op">$</span><span class="va">osm_polygons</span><span class="op">$</span><span class="va">osm_id</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="op">)</span> |&gt; <span class="co"># extracting polygons</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="st">"Lima Metropolitana"</span><span class="op">)</span> |&gt; <span class="co"># only at specific city level</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><code>suggest_crs()</code> from the <strong>crsuggest package</strong> returns the top 10 matches for a given input spatial dataset enabeling to browse the returned CRS option and use the EPSG/proj4string codes in your analysis. This package is usefull for customizing arguments (gcs and measurement units) as guessing the CRS of a dataset without projection information.</p>
<div class="cell page-columns page-full" data-hash="index_cache/html/crs_12b1f426bbd3ddcceb6900fbf72cf750">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">possible_crs</span> <span class="op">&lt;-</span> <span class="fu">suggest_crs</span><span class="op">(</span><span class="va">Lima_multipolygons</span><span class="op">)</span>
<span class="fu">kable</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">possible_crs</span>, <span class="st">"simple"</span><span class="op">)</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<table class="table table-sm table-striped">

<colgroup>
<col style="width: 4%">
<col style="width: 16%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 65%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">crs_code</th>
<th style="text-align: left;">crs_name</th>
<th style="text-align: left;">crs_type</th>
<th style="text-align: right;">crs_gcs</th>
<th style="text-align: left;">crs_units</th>
<th style="text-align: left;">crs_proj4</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">5387</td>
<td style="text-align: left;">Peru96 / UTM zone 18S</td>
<td style="text-align: left;">projected</td>
<td style="text-align: right;">5373</td>
<td style="text-align: left;">m</td>
<td style="text-align: left;">+proj=utm +zone=18 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs</td>
</tr>
<tr class="even">
<td style="text-align: left;">24892</td>
<td style="text-align: left;">PSAD56 / Peru central zone</td>
<td style="text-align: left;">projected</td>
<td style="text-align: right;">4248</td>
<td style="text-align: left;">m</td>
<td style="text-align: left;">+proj=tmerc +lat_0=-9.5 +lon_0=-76 +k=0.99932994 +x_0=720000 +y_0=1039979.159 +ellps=intl +towgs84=-279,175,-379,0,0,0,0 +units=m +no_defs</td>
</tr>
<tr class="odd">
<td style="text-align: left;">24878</td>
<td style="text-align: left;">PSAD56 / UTM zone 18S</td>
<td style="text-align: left;">projected</td>
<td style="text-align: right;">4248</td>
<td style="text-align: left;">m</td>
<td style="text-align: left;">+proj=utm +zone=18 +south +ellps=intl +units=m +no_defs</td>
</tr>
<tr class="even">
<td style="text-align: left;">29188</td>
<td style="text-align: left;">SAD69 / UTM zone 18S</td>
<td style="text-align: left;">projected</td>
<td style="text-align: right;">4618</td>
<td style="text-align: left;">m</td>
<td style="text-align: left;">+proj=utm +zone=18 +south +ellps=aust_SA +towgs84=-57,1,-41,0,0,0,0 +units=m +no_defs</td>
</tr>
<tr class="odd">
<td style="text-align: left;">31993</td>
<td style="text-align: left;">SIRGAS 1995 / UTM zone 18S</td>
<td style="text-align: left;">projected</td>
<td style="text-align: right;">4170</td>
<td style="text-align: left;">m</td>
<td style="text-align: left;">+proj=utm +zone=18 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs</td>
</tr>
<tr class="even">
<td style="text-align: left;">31978</td>
<td style="text-align: left;">SIRGAS 2000 / UTM zone 18S</td>
<td style="text-align: left;">projected</td>
<td style="text-align: right;">4674</td>
<td style="text-align: left;">m</td>
<td style="text-align: left;">+proj=utm +zone=18 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs</td>
</tr>
<tr class="odd">
<td style="text-align: left;">32718</td>
<td style="text-align: left;">WGS 84 / UTM zone 18S</td>
<td style="text-align: left;">projected</td>
<td style="text-align: right;">4326</td>
<td style="text-align: left;">m</td>
<td style="text-align: left;">+proj=utm +zone=18 +south +datum=WGS84 +units=m +no_defs</td>
</tr>
<tr class="even">
<td style="text-align: left;">32518</td>
<td style="text-align: left;">WGS 72BE / UTM zone 18S</td>
<td style="text-align: left;">projected</td>
<td style="text-align: right;">4324</td>
<td style="text-align: left;">m</td>
<td style="text-align: left;">+proj=utm +zone=18 +south +ellps=WGS72 +towgs84=0,0,1.9,0,0,0.814,-0.38 +units=m +no_defs</td>
</tr>
<tr class="odd">
<td style="text-align: left;">32318</td>
<td style="text-align: left;">WGS 72 / UTM zone 18S</td>
<td style="text-align: left;">projected</td>
<td style="text-align: right;">4322</td>
<td style="text-align: left;">m</td>
<td style="text-align: left;">+proj=utm +zone=18 +south +ellps=WGS72 +towgs84=0,0,4.5,0,0,0.554,0.2263 +units=m +no_defs</td>
</tr>
<tr class="even">
<td style="text-align: left;">6932</td>
<td style="text-align: left;">WGS 84 / NSIDC EASE-Grid 2.0 South</td>
<td style="text-align: left;">projected</td>
<td style="text-align: right;">4326</td>
<td style="text-align: left;">m</td>
<td style="text-align: left;">+proj=laea +lat_0=-90 +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs</td>
</tr>
</tbody>
</table>
<div class="quarto-table-caption margin-caption">Possible CRS </div></div>
</div>
<p>Now we can covert the GIS coordinates to CRS using <code>st_transform</code></p>
<div class="cell" data-hash="index_cache/html/object_c8d86b4addda5cb394bb68f981b44d3b">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co"># convert the GIS coordinates to CRS</span>
<span class="va">Lima_multipolygons</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">Lima_multipolygons</span>, <span class="st">"EPSG:24892"</span><span class="op">)</span>

<span class="va">Lima_multipolygons</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>sf [1, 1]
active geometry column: geometry (MULTIPOLYGON)
crs: 24892 (PSAD56 / Peru central zone)
crs unit: metre
geometry sfc MPOLY 181.49kB</code></pre>
</div>
</div>
<p>See <a href="https://wiki.openstreetmap.org/wiki/Overpass_API#Resource_management_options_.28osm-script.29">OPQ</a> for explanation of timeout and memsize (or maxsize in overpass terms). See ESPG codes on <a href="https://spatialreference.org/ref/epsg/">spatialreference.org</a>. See <a href="https://nominatim.openstreetmap.org/ui/details.html?osmtype=N&amp;osmid=4289361265&amp;class=place">nominatim</a> for <strong>admin_level</strong> keys. Search for feature in the following table.</p>
<div>
<details><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">page</span> <span class="op">&lt;-</span> <span class="fu">read_html</span><span class="op">(</span><span class="st">"https://wiki.openstreetmap.org/wiki/Map_features"</span><span class="op">)</span>

<span class="va">features_list</span> <span class="op">&lt;-</span> <span class="fu">html_nodes</span><span class="op">(</span><span class="va">page</span>, css <span class="op">=</span> <span class="st">".toctext"</span><span class="op">)</span> |&gt;
  <span class="fu">html_text2</span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu">rename</span><span class="op">(</span>feature <span class="op">=</span> <span class="fu">starts_with</span><span class="op">(</span><span class="st">"html"</span><span class="op">)</span><span class="op">)</span>

<span class="fu">datatable</span><span class="op">(</span><span class="va">features_list</span>,
  options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    searchHighlight <span class="op">=</span> <span class="cn">TRUE</span>,
    dom <span class="op">=</span> <span class="st">"ltipr"</span> <span class="co"># Deactivate search box</span>
  <span class="op">)</span>,
  filter <span class="op">=</span> <span class="st">"top"</span> <span class="co"># Deactivate search box</span>
  , selection <span class="op">=</span> <span class="st">"multiple"</span>, <span class="co"># Deactivate search box</span>
  , escape <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># Deactivate search box</span>
  , width <span class="op">=</span> <span class="st">"300px"</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div id="tbl-osm-features" class="cell tbl-parent quarto-layout-panel anchored" data-tbl-cap="OSM features table" data-caption="OSM_features" data-hash="index_cache/html/tbl-osm-features_05a3dc3a247b0f4c333f1da8a57ffe91">
<div class="panel-caption table-caption">
<p><strong>?(caption)</strong></p>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">

<div id="htmlwidget-f79a35d194e0a0c8e6b0" style="width:300px;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f79a35d194e0a0c8e6b0">{"x":{"filter":"top","vertical":false,"filterHTML":"<tr>\n  <td><\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114"],["Primary features","Aerialway","Aeroway","Amenity","Sustenance","Education","Transportation","Financial","Healthcare","Entertainment, Arts & Culture","Public Service","Facilities","Waste Management","Others","Barrier","Linear barriers","Access control on highways","Boundary","Boundary types","Attributes","Building","Accommodation","Commercial","Religious","Civic/amenity","Agricultural/plant production","Sports","Storage","Cars","Power/technical buildings","Other buildings","Additional attributes","Craft","Emergency","Medical rescue","Firefighters","Lifeguards","Assembly point","Other structure","Geological","Healthcare","Highway","Roads","Link roads","Special road types","Paths","When sidewalk/crosswalk is tagged as a separate way","When sidewalk (or pavement) is tagged on the main roadway (see Sidewalks)","When cycleway is drawn as its own way (see Bicycle)","Cycleway tagged on the main roadway or lane (see Bicycle)","Lifecycle (see also lifecycle prefixes)","Attributes","Other highway features","Historic","Landuse","Common landuse key values - developed land","Common landuse key values - rural and agricultural land","Common landuse key values - waterbody","Other landuse key values","Leisure","Man made","Military","Natural","Vegetation","Water related","Geology related","Office","Place","Administratively declared places","Populated settlements, urban","Populated settlements, urban and rural","Other places","Additional attributes","Power","Public transport","Railway","Tracks","Additional features","Stations and Stops","Other railways","Route","Shop","Food, beverages","General store, department store, mall","Clothing, shoes, accessories","Discount store, charity","Health and beauty","Do-it-yourself, household, building materials, gardening","Furniture and interior","Electronics","Outdoors and sport, vehicles","Art, music, hobbies","Stationery, gifts, books, newspapers","Others","Sport","Telecom","Tourism","Water","Waterway","Natural watercourses","Man-made waterways","Facilities","Barriers on waterways","Other features on waterways","Additional properties","Addresses","Tags for individual houses","For countries using hamlet, subdistrict, district, province, state, county","Tags for interpolation ways","Annotations","Name","Properties","References","Restrictions"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>feature<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"searchHighlight":true,"dom":"ltipr","columnDefs":[{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</div>
</div>
<p>In order to select <a href="https://wiki.openstreetmap.org/wiki/Map_Features">Features</a> there is a list available with 114 features, as shown in <span class="citation" data-cites="OSM_features">@OSM_features</span>. We can also use the <code>available_features( )</code> function that returns a list of available OSM features that have different tags.</p>
<p>Lets map the boundaries of the selected city.</p>
<div class="cell page-columns page-full" data-hash="index_cache/html/first-plot_059ee8d59f50733b50e92bb90466cdd7">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="Figs/first-plot-1.png" class="img-fluid figure-img" width="6000"></p>
<p></p><figcaption class="figure-caption margin-caption">First general plot of the city.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<!-- ![First plot.](r`knitr::fig_chunk('Figs/first-plot','png')`) -->
</section><section id="adding-data-streets-buildings-and-population-density" class="level1 page-columns page-full" data-number="4"><h1 data-number="4">
<span class="header-section-number">4</span> Adding data: Streets, buildings, and population density</h1>
<div class="cell" data-hash="index_cache/html/adding-data-roads_872ffd601bd646e4495e220b014239d8">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">roads</span> <span class="op">&lt;-</span>
  <span class="fu">getbb</span><span class="op">(</span><span class="st">"Lima Metropolitana"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">opq</span><span class="op">(</span>timeout <span class="op">=</span> <span class="fl">20</span> <span class="op">*</span> <span class="fl">110</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">add_osm_feature</span><span class="op">(</span> <span class="co"># requesting features related to highway</span>
    key <span class="op">=</span> <span class="st">"highway"</span>,
    value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"trunk"</span>,
      <span class="st">"primary"</span>,
      <span class="st">"secondary"</span>
      <span class="co"># ,"tertiary"</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">osmdata_sf</span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="index_cache/html/wrangling-data-roads_23c2a3bd7c5fd8f4bea8491a3b3605bd">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">roads_sf</span> <span class="op">&lt;-</span> <span class="va">roads</span> |&gt;
  <span class="op">(</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">osm_lines</span><span class="op">(</span><span class="va">x</span>, <span class="va">x</span><span class="op">$</span><span class="va">osm_lines</span><span class="op">$</span><span class="va">osm_id</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="co"># which means using other type of geometry</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span> |&gt;
  <span class="fu">st_transform</span><span class="op">(</span><span class="st">"EPSG:24892"</span><span class="op">)</span> |&gt;
  <span class="fu">st_intersection</span><span class="op">(</span><span class="va">Lima_multipolygons</span><span class="op">)</span> |&gt; <span class="co"># only highways in the city</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">st_is</span><span class="op">(</span><span class="va">geometry</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LINESTRING"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># assure only line geometry</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell page-columns page-full" data-hash="index_cache/html/roads-plot_c7302cc1f82d0cad1bf85530aa1370d1">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="Figs/roads-plot-1.png" class="img-fluid figure-img" width="6000"></p>
<p></p><figcaption class="figure-caption margin-caption">Adding layer of roads to map.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-hash="index_cache/html/adding-data-buildings_359c293d10e6c92a6bd5a89e6187c803">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">buildings_sf</span> <span class="op">&lt;-</span>
  <span class="fu">getbb</span><span class="op">(</span><span class="st">"Lima Metropolitana"</span><span class="op">)</span> |&gt;
  <span class="fu">opq</span><span class="op">(</span>timeout <span class="op">=</span> <span class="fl">20</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span> |&gt;
  <span class="fu">add_osm_feature</span><span class="op">(</span>
    key <span class="op">=</span> <span class="st">"building"</span>,
    value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="co"># Accommodation</span>
      <span class="st">"apartments"</span>, <span class="st">"house"</span>, <span class="st">"residential"</span>
      <span class="co"># Commercial</span>
      , <span class="st">"commercial"</span>, <span class="st">"office"</span>, <span class="st">"retail"</span>, <span class="st">"supermarket"</span>
      <span class="co"># Religious</span>
      , <span class="st">"cathedral"</span>, <span class="st">"church"</span>
      <span class="co"># Civic/amenity</span>
      , <span class="st">"civic"</span>, <span class="st">"college"</span>, <span class="st">"government"</span>, <span class="st">" hospital"</span>, <span class="st">"public"</span>, <span class="st">"transportation"</span>, <span class="st">"university"</span>
      <span class="co"># Other buildings</span>
      , <span class="st">"bridge"</span>
    <span class="op">)</span>
  <span class="op">)</span> |&gt;
  <span class="fu">osmdata_sf</span><span class="op">(</span><span class="op">)</span>

<span class="va">buildings_sf</span> <span class="op">&lt;-</span> <span class="va">buildings_sf</span> |&gt;
  <span class="op">(</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">osm_polygons</span><span class="op">(</span><span class="va">x</span>, <span class="va">x</span><span class="op">$</span><span class="va">osm_polygons</span><span class="op">$</span><span class="va">osm_id</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span> |&gt;
  <span class="fu">st_transform</span><span class="op">(</span><span class="st">"EPSG:24892"</span><span class="op">)</span> |&gt;
  <span class="fu">st_intersection</span><span class="op">(</span><span class="va">Lima_multipolygons</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell page-columns page-full" data-hash="index_cache/html/buildings-plot_cfa1f6c41c971921cd6934ca72af2c08">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="Figs/buildings-plot-1.png" class="img-fluid figure-img" width="6000"></p>
<p></p><figcaption class="figure-caption margin-caption">Adding layer of buildings to map.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>For obtaining population data we use data from the National Institute of Statistics and Informatics (INEI, 2018).</p>
<div class="cell" data-hash="index_cache/html/otaining-population-data_7c6294ceec77b18400d5dc251abba850">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu">read_sf</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"EstratoLimaMetropolitanashp.shp"</span><span class="op">)</span><span class="op">)</span>

<span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">shp</span>, <span class="st">"EPSG:24892"</span><span class="op">)</span> <span class="co"># Extra care is needed with the ESRI shapefile format, because WKT1 does not store axis order unambiguously.</span>

<span class="fu">st_layers</span><span class="op">(</span>dsn <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"EstratoLimaMetropolitanashp.shp"</span><span class="op">)</span>, do_count <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">name</span> <span class="co"># Displays list of layers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] "EstratoLimaMetropolitanashp"</code></pre>
</div>
</div>
<p>Population data is in geodetic CRS, we need to transform this data to Projected CRS. More details about the difference between these systems <a href="https://www.earthdatascience.org/courses/use-data-open-source-python/intro-vector-data-python/spatial-data-vector-shapefiles/geographic-vs-projected-coordinate-reference-systems-python/">here</a>.</p>
<div class="cell" data-hash="index_cache/html/wrangling-population-data_eba0f8ee003c713302de779eb51b46af">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">population_sf</span> <span class="op">&lt;-</span> <span class="va">shp</span> |&gt;
  <span class="fu">st_intersection</span><span class="op">(</span><span class="va">Lima_multipolygons</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell page-columns page-full" data-hash="index_cache/html/population-plot_fb59793211303cd41a95dbd7d6a57df2">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="Figs/population-plot-1.png" class="img-fluid figure-img" width="6000"></p>
<p></p><figcaption class="figure-caption margin-caption">Adding layer of population to map.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<section id="tilting-sf-objects" class="level2 page-columns page-full" data-number="4.1"><h2 data-number="4.1" class="anchored" data-anchor-id="tilting-sf-objects">
<span class="header-section-number">4.1</span> Tilting sf objects</h2>
<p>Following <a href="https://stefanjuenger.github.io/gesis-workshop-geospatial-techniques-R/slides/2_4_Advanced_Maps_II/2_4_Advanced_Maps_II.html#4">Stefan Jünger</a> we will tilt each sf object by:</p>
<ol type="1">
<li>Displace each point in a fixed direction, by an amount proportional to its signed distance from the line that is parallel to that direction and goes through the origin (plane angle), while preserving the size of the area (shearing),</li>
<li>rotate each plane / layer, and</li>
<li>offset x and y axis.</li>
</ol>
<p>We will apply this by using the following formula:</p>
<p><span class="math display">\[
\begin{bmatrix} x &amp; y \end{bmatrix} \times \begin{bmatrix} 1 &amp; 0 \\ 1.2 &amp; 1 \end{bmatrix} \times \begin{bmatrix} \cos(\pi/20) &amp; \sin(\pi/20)\\-\sin(\pi/20) &amp; \cos(\pi/20) \end{bmatrix} + \begin{bmatrix} x\_add &amp; y\_add \end{bmatrix}
\]</span></p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Function to tilt sf objects code by <a href="https://stefanjuenger.github.io/gesis-workshop-geospatial-techniques-R/slides/2_4_Advanced_Maps_II/2_4_Advanced_Maps_II.html#4">Stefan Jünger</a>. Consider that <span class="math inline">\(\pi/20 = 9\text{o}\)</span> and that <span class="math inline">\(\cos(\pi/20) \approx 0.987\)</span> width and <span class="math inline">\(\sin(\pi/20) \approx 0.156\)</span> height in an unit circle.</p>
</div></div><div class="cell caption-margin" data-hash="index_cache/html/tilting-function_4a6c233328e4e2e2fd7ecffc87bf2a0b">

</div>
<!-- ![Roads plot.](r`knitr::fig_chunk('Figs/roads-plot','png')`) -->
</section></section><section id="visualize-data-with-ggplot2-tmap-leaflet-and-sfmap" class="level1" data-number="5"><h1 data-number="5">
<span class="header-section-number">5</span> Visualize data with ggplot2, tmap, leaflet and sfmap</h1>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">ggplot2</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">sfmap</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false" href="">ggmap</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false" href="">tmap</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" role="tab" aria-controls="tabset-1-5" aria-selected="false" href="">leaflet</a></li>
</ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell" data-hash="index_cache/html/Plot-tilting-layers_7ac983af1214b55ac2cd1a19abd759b9">
<div class="cell-output-display">
<p><img src="Figs/Plot-tilting-layers-1.png" class="img-fluid" width="3600"></p>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">

</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">

</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">

</div>
<div id="tabset-1-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-5-tab">

</div>
</div>
</div>
</section><section id="appendix" class="level1" data-number="6"><h1 data-number="6">
<span class="header-section-number">6</span> Appendix</h1>
<details><summary>
Reuse
</summary><p><a href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></p>
</details><details><summary>
All code for this report
</summary><div class="cell" data-hash="index_cache/html/All-code_f92f0dfc644570c6ce40360e1c69a9ef">
<details><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">knitted_when</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">knitted_where</span> <span class="op">&lt;-</span> <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/current_input.html">current_input</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">knitted_with</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html">packageVersion</a></span><span class="op">(</span><span class="st">"knitr"</span><span class="op">)</span>
<span class="va">knitted_doc_url</span> <span class="op">&lt;-</span> <span class="fu">downlit</span><span class="fu">::</span><span class="fu"><a href="https://downlit.r-lib.org/reference/autolink.html">autolink_url</a></span><span class="op">(</span><span class="st">"knitr::knit()"</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span>
  <span class="va">tidyverse</span>,
  <span class="va">tidylog</span>,
  <span class="va">Cairo</span>,
  <span class="va">here</span>,
  <span class="va">dplyr</span>,
  <span class="va">crsuggest</span> <span class="co"># Suggest CRS information for spatial data</span>
  , <span class="va">ggplot2</span>,
  <span class="va">ggnewscale</span> <span class="co"># For multiple fill and colour scales in ggplot2</span>
  , <span class="va">ggsn</span> <span class="co"># North Symbols and Scale Bars for Maps</span>
  , <span class="va">osmdata</span> <span class="co"># For downloading and using data from OSM</span>
  , <span class="va">sf</span> <span class="co"># DONT'T FORGET uses the s2geometry library</span>
  , <span class="va">knitr</span>,
  <span class="va">rvest</span> <span class="co"># For Web scrapping</span>
  , <span class="va">DT</span> <span class="co"># R interface to the JavaScript library DataTables</span>
  , <span class="va">downlit</span> <span class="co"># For syntax highlighting and automatic linking</span>
  , <span class="va">git2r</span> <span class="co"># Provides access to 'Git' repositories</span>
  , <span class="va">xfun</span> <span class="co"># For alternative Session Info</span>
<span class="op">)</span>

<span class="co"># pacman::p_update()         # Update out-of-date packages</span>

<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>scipen <span class="op">=</span> <span class="fl">100</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># Prefer non-scientific notation</span>

<span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>
  dev <span class="op">=</span> <span class="st">"CairoPNG"</span> <span class="co"># Alpha transparency in png</span>
  , fig.path <span class="op">=</span> <span class="st">"Figs/"</span>,
  dpi <span class="op">=</span> <span class="fl">600</span>,
  fig.width <span class="op">=</span> <span class="fl">10</span>,
  fig.hight <span class="op">=</span> <span class="fl">12</span>
  <span class="co"># Automatically formatting code using styler</span>
  , tidy <span class="op">=</span> <span class="st">"styler"</span>
<span class="op">)</span>

<span class="va">Lima</span> <span class="op">&lt;-</span>
  <span class="fu">getbb</span><span class="op">(</span><span class="st">"Lima Metropolitana"</span><span class="op">)</span> |&gt; <span class="co"># obtaining boundaries</span>
  <span class="fu">opq</span><span class="op">(</span>timeout <span class="op">=</span> <span class="fl">20</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span> |&gt; <span class="co"># overpass query</span>
  <span class="fu">add_osm_feature</span><span class="op">(</span> <span class="co"># retrieve administrative boundaries</span>
    key <span class="op">=</span> <span class="st">"admin_level"</span>,
    value <span class="op">=</span> <span class="st">"5"</span> <span class="co"># boundary box at the met level</span>
  <span class="op">)</span> |&gt;
  <span class="fu">osmdata_sf</span><span class="op">(</span><span class="op">)</span> <span class="co"># import as an sf object</span>

<span class="va">Lima_multipolygons</span> <span class="op">&lt;-</span> <span class="va">Lima</span> |&gt;
  <span class="op">(</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">osm_multipolygons</span><span class="op">(</span><span class="va">x</span>, <span class="va">x</span><span class="op">$</span><span class="va">osm_polygons</span><span class="op">$</span><span class="va">osm_id</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="op">)</span> |&gt; <span class="co"># extracting polygons</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="st">"Lima Metropolitana"</span><span class="op">)</span> |&gt; <span class="co"># only at specific city level</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span>

<span class="va">possible_crs</span> <span class="op">&lt;-</span> <span class="fu">suggest_crs</span><span class="op">(</span><span class="va">Lima_multipolygons</span><span class="op">)</span>
<span class="fu">kable</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">possible_crs</span>, <span class="st">"simple"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># convert the GIS coordinates to CRS</span>
<span class="va">Lima_multipolygons</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">Lima_multipolygons</span>, <span class="st">"EPSG:24892"</span><span class="op">)</span>

<span class="va">Lima_multipolygons</span>
<span class="va">page</span> <span class="op">&lt;-</span> <span class="fu">read_html</span><span class="op">(</span><span class="st">"https://wiki.openstreetmap.org/wiki/Map_features"</span><span class="op">)</span>

<span class="va">features_list</span> <span class="op">&lt;-</span> <span class="fu">html_nodes</span><span class="op">(</span><span class="va">page</span>, css <span class="op">=</span> <span class="st">".toctext"</span><span class="op">)</span> |&gt;
  <span class="fu">html_text2</span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu">rename</span><span class="op">(</span>feature <span class="op">=</span> <span class="fu">starts_with</span><span class="op">(</span><span class="st">"html"</span><span class="op">)</span><span class="op">)</span>

<span class="fu">datatable</span><span class="op">(</span><span class="va">features_list</span>,
  options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    searchHighlight <span class="op">=</span> <span class="cn">TRUE</span>,
    dom <span class="op">=</span> <span class="st">"ltipr"</span> <span class="co"># Deactivate search box</span>
  <span class="op">)</span>,
  filter <span class="op">=</span> <span class="st">"top"</span> <span class="co"># Deactivate search box</span>
  , selection <span class="op">=</span> <span class="st">"multiple"</span>, <span class="co"># Deactivate search box</span>
  , escape <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># Deactivate search box</span>
  , width <span class="op">=</span> <span class="st">"300px"</span>
<span class="op">)</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="va">Lima_multipolygons</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggsn</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggsn/man/blank.html">blank</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">roads</span> <span class="op">&lt;-</span>
  <span class="fu">getbb</span><span class="op">(</span><span class="st">"Lima Metropolitana"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">opq</span><span class="op">(</span>timeout <span class="op">=</span> <span class="fl">20</span> <span class="op">*</span> <span class="fl">110</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">add_osm_feature</span><span class="op">(</span> <span class="co"># requesting features related to highway</span>
    key <span class="op">=</span> <span class="st">"highway"</span>,
    value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"trunk"</span>,
      <span class="st">"primary"</span>,
      <span class="st">"secondary"</span>
      <span class="co"># ,"tertiary"</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">osmdata_sf</span><span class="op">(</span><span class="op">)</span>

<span class="va">roads_sf</span> <span class="op">&lt;-</span> <span class="va">roads</span> |&gt;
  <span class="op">(</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">osm_lines</span><span class="op">(</span><span class="va">x</span>, <span class="va">x</span><span class="op">$</span><span class="va">osm_lines</span><span class="op">$</span><span class="va">osm_id</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="co"># which means using other type of geometry</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span> |&gt;
  <span class="fu">st_transform</span><span class="op">(</span><span class="st">"EPSG:24892"</span><span class="op">)</span> |&gt;
  <span class="fu">st_intersection</span><span class="op">(</span><span class="va">Lima_multipolygons</span><span class="op">)</span> |&gt; <span class="co"># only highways in the city</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">st_is</span><span class="op">(</span><span class="va">geometry</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LINESTRING"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># assure only line geometry</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#---The layer added later will come on top of the preceding layers---#</span>
  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">Lima_multipolygons</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">roads_sf</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggsn</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggsn/man/blank.html">blank</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">buildings_sf</span> <span class="op">&lt;-</span>
  <span class="fu">getbb</span><span class="op">(</span><span class="st">"Lima Metropolitana"</span><span class="op">)</span> |&gt;
  <span class="fu">opq</span><span class="op">(</span>timeout <span class="op">=</span> <span class="fl">20</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span> |&gt;
  <span class="fu">add_osm_feature</span><span class="op">(</span>
    key <span class="op">=</span> <span class="st">"building"</span>,
    value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="co"># Accommodation</span>
      <span class="st">"apartments"</span>, <span class="st">"house"</span>, <span class="st">"residential"</span>
      <span class="co"># Commercial</span>
      , <span class="st">"commercial"</span>, <span class="st">"office"</span>, <span class="st">"retail"</span>, <span class="st">"supermarket"</span>
      <span class="co"># Religious</span>
      , <span class="st">"cathedral"</span>, <span class="st">"church"</span>
      <span class="co"># Civic/amenity</span>
      , <span class="st">"civic"</span>, <span class="st">"college"</span>, <span class="st">"government"</span>, <span class="st">" hospital"</span>, <span class="st">"public"</span>, <span class="st">"transportation"</span>, <span class="st">"university"</span>
      <span class="co"># Other buildings</span>
      , <span class="st">"bridge"</span>
    <span class="op">)</span>
  <span class="op">)</span> |&gt;
  <span class="fu">osmdata_sf</span><span class="op">(</span><span class="op">)</span>

<span class="va">buildings_sf</span> <span class="op">&lt;-</span> <span class="va">buildings_sf</span> |&gt;
  <span class="op">(</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">osm_polygons</span><span class="op">(</span><span class="va">x</span>, <span class="va">x</span><span class="op">$</span><span class="va">osm_polygons</span><span class="op">$</span><span class="va">osm_id</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span> |&gt;
  <span class="fu">st_transform</span><span class="op">(</span><span class="st">"EPSG:24892"</span><span class="op">)</span> |&gt;
  <span class="fu">st_intersection</span><span class="op">(</span><span class="va">Lima_multipolygons</span><span class="op">)</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#---The layer added later will come on top of the preceding layers---#</span>
  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">Lima_multipolygons</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">buildings_sf</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggsn</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggsn/man/blank.html">blank</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu">read_sf</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"EstratoLimaMetropolitanashp.shp"</span><span class="op">)</span><span class="op">)</span>

<span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">shp</span>, <span class="st">"EPSG:24892"</span><span class="op">)</span> <span class="co"># Extra care is needed with the ESRI shapefile format, because WKT1 does not store axis order unambiguously.</span>

<span class="fu">st_layers</span><span class="op">(</span>dsn <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"EstratoLimaMetropolitanashp.shp"</span><span class="op">)</span>, do_count <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">name</span> <span class="co"># Displays list of layers</span>


<span class="va">population_sf</span> <span class="op">&lt;-</span> <span class="va">shp</span> |&gt;
  <span class="fu">st_intersection</span><span class="op">(</span><span class="va">Lima_multipolygons</span><span class="op">)</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#---The layer added later will come on top of the preceding layers---#</span>
  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">Lima_multipolygons</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">population_sf</span>, <span class="va">POB</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">POB</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggsn</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggsn/man/blank.html">blank</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">rotate_sf</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">x_add</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">y_add</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">shear_matrix</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1.2</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">rotate_matrix</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">data</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
      geometry <span class="op">=</span>
        <span class="va">.</span><span class="op">$</span><span class="va">geometry</span> <span class="op">*</span> <span class="fu">shear_matrix</span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="fu">rotate_matrix</span><span class="op">(</span><span class="va">pi</span> <span class="op">/</span> <span class="fl">20</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">x_add</span>, <span class="va">y_add</span><span class="op">)</span>
    <span class="op">)</span>
<span class="op">}</span>
<span class="co"># Parameters, plot 1st with coordinates and retrieve x and initial y values</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">2320000</span>

<span class="co"># Plot tilted layers</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#-----------First layer includes borders and roads---------------#</span>
  <span class="fu">geom_sf</span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">Lima_multipolygons</span> |&gt; <span class="fu">rotate_sf</span><span class="op">(</span><span class="op">)</span>,
    fill <span class="op">=</span> <span class="cn">NA</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">roads_sf</span> |&gt; <span class="fu">rotate_sf</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>,
    label <span class="op">=</span> <span class="st">"Roads"</span>,
    x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="fl">420000</span>, hjust <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"CornflowerBlue"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>caption <span class="op">=</span> <span class="st">"Visualization by @Andrei-WongE"</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#-----------Second layer includes borders and buildings----------#</span>
  <span class="fu">geom_sf</span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">Lima_multipolygons</span> |&gt; <span class="fu">rotate_sf</span><span class="op">(</span>y_add <span class="op">=</span> <span class="fl">100000</span><span class="op">)</span>,
    fill <span class="op">=</span> <span class="cn">NA</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">rotate_sf</span><span class="op">(</span><span class="va">buildings_sf</span>, y_add <span class="op">=</span> <span class="fl">100000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>,
    label <span class="op">=</span> <span class="st">"Buildings"</span>,
    x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="fl">520000</span>, hjust <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"CornflowerBlue"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="co">#-----------Third layer includes population---------------------#</span>
  <span class="fu">geom_sf</span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">Lima_multipolygons</span> |&gt; <span class="fu">rotate_sf</span><span class="op">(</span>y_add <span class="op">=</span> <span class="fl">200000</span><span class="op">)</span>,
    fill <span class="op">=</span> <span class="cn">NA</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>
    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">population_sf</span>, <span class="va">POB</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> |&gt; <span class="fu">rotate_sf</span><span class="op">(</span>y_add <span class="op">=</span> <span class="fl">200000</span><span class="op">)</span>,
    <span class="fu">aes</span><span class="op">(</span>
      fill <span class="op">=</span> <span class="va">POB</span>,
      alpha <span class="op">=</span> <span class="fl">.7</span>
    <span class="op">)</span>,
    color <span class="op">=</span> <span class="cn">NA</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"E"</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># E = cividis</span>
  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>,
    label <span class="op">=</span> <span class="st">"Population"</span>,
    x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="fl">620000</span>, hjust <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"CornflowerBlue"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="co"># theme(legend.position = "none"</span>
  <span class="co">#      , plot.caption   = element_text(hjust = 0.5)) + #Centre align caption</span>
  <span class="co"># ggsn::blank()</span>
  <span class="co">#-----------Fourth layer includes socio-economic strata--------#</span>
  <span class="fu">new_scale_fill</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">new_scale_color</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">Lima_multipolygons</span> |&gt; <span class="fu">rotate_sf</span><span class="op">(</span>y_add <span class="op">=</span> <span class="fl">300000</span><span class="op">)</span>,
    fill <span class="op">=</span> <span class="cn">NA</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>
    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">population_sf</span>, <span class="va">POB</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> |&gt; <span class="fu">rotate_sf</span><span class="op">(</span>y_add <span class="op">=</span> <span class="fl">300000</span><span class="op">)</span>,
    <span class="fu">aes</span><span class="op">(</span>
      fill <span class="op">=</span> <span class="va">ESTR_INGPE</span>,
      alpha <span class="op">=</span> <span class="fl">.7</span>
    <span class="op">)</span>,
    color <span class="op">=</span> <span class="cn">NA</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"A"</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># A = magma</span>
  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>,
    label <span class="op">=</span> <span class="st">"Socio-economic strata (by income pc of households)"</span>,
    x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="fl">720000</span>, hjust <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"CornflowerBlue"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">coord_sf</span><span class="op">(</span>clip <span class="op">=</span> <span class="st">"off"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># Keeps the annotation from disappearing</span>
  <span class="fu">theme</span><span class="op">(</span>
    legend.position <span class="op">=</span> <span class="st">"none"</span>,
    plot.caption <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> <span class="co"># Centre align caption</span>
  <span class="fu">ggsn</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggsn/man/blank.html">blank</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## Datetime</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## Repository</span>
<span class="fu">git2r</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/git2r/reference/repository.html">repository</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## session info</span>
<span class="fu">xfun</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xfun/man/session_info.html">session_info</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</details><details><summary>
Reproducibility receipt
</summary><div class="cell" data-hash="index_cache/html/Reproducibility-receipt_8f9fc91e8386295e09eb2402dd39395f">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-08-10 16:54:11 -05"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Local:    origin D:/Documents/R/R_projects/OSM_Lima
Remote:   origin @ origin (https://github.com/Andrei-WongE/Spatial_notes.git)
Head:     [a8304d9] 2022-08-10: Corrected errors</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.2.1 (2022-06-23 ucrt)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 19044)

Locale:
  LC_COLLATE=Spanish_Peru.utf8  LC_CTYPE=Spanish_Peru.utf8   
  LC_MONETARY=Spanish_Peru.utf8 LC_NUMERIC=C                 
  LC_TIME=Spanish_Peru.utf8    

Package version:
  askpass_1.1             assertthat_0.2.1        backports_1.4.1        
  base64enc_0.1-3         bit_4.0.4               bit64_4.0.5            
  bitops_1.0-7            blob_1.2.3              brew_1.0.7             
  brio_1.1.3              broom_0.8.0             bslib_0.3.1            
  cachem_1.0.6            Cairo_1.5-15            callr_3.7.0            
  cellranger_1.1.0        class_7.3-20            classInt_0.4-7         
  cli_3.3.0               clipr_0.8.0             clisymbols_1.2.0       
  codetools_0.2-18        colorspace_2.0-3        compiler_4.2.1         
  cpp11_0.4.2             crayon_1.5.1            crosstalk_1.2.0        
  crsmeta_0.3.0           crsuggest_0.3.1         curl_4.3.2             
  data.table_1.14.2       DBI_1.1.3               dbplyr_2.2.0           
  desc_1.4.1              digest_0.6.29           downlit_0.4.0          
  dplyr_1.0.9             DT_0.23                 dtplyr_1.2.1           
  e1071_1.7-11            ellipsis_0.3.2          evaluate_0.15          
  fansi_1.0.3             farver_2.1.0            fastmap_1.1.0          
  forcats_0.5.1           foreign_0.8-82          fs_1.5.2               
  gargle_1.2.0            generics_0.1.2          geojsonsf_2.0.3        
  geometries_0.2.0        ggmap_3.0.0             ggnewscale_0.4.7       
  ggplot2_3.3.6           ggsn_0.5.0              git2r_0.30.1           
  glue_1.6.2              googledrive_2.0.0       googlesheets4_1.0.0    
  graphics_4.2.1          grDevices_4.2.1         grid_4.2.1             
  gridExtra_2.3           gtable_0.3.0            haven_2.5.0            
  here_1.0.1              highr_0.9               hms_1.1.1              
  htmltools_0.5.2         htmlwidgets_1.5.4       httpuv_1.6.5           
  httr_1.4.3              httr2_0.2.1             ids_1.0.1              
  isoband_0.2.5           jpeg_0.1-9              jquerylib_0.1.4        
  jsonify_1.2.1           jsonlite_1.8.0          KernSmooth_2.23-20     
  keypress_1.2.0          knitr_1.39              labeling_0.4.2         
  later_1.3.0             lattice_0.20-45         lazyeval_0.2.2         
  leafem_0.2.0            leaflet_2.1.1           leaflet.providers_1.9.0
  leafpop_0.1.0           lifecycle_1.0.1         lobstr_1.1.2           
  lubridate_1.8.0         magrittr_2.0.3          maptools_1.1-4         
  mapview_2.11.0          markdown_1.1            MASS_7.3.57            
  Matrix_1.4.1            memoise_2.0.1           methods_4.2.1          
  mgcv_1.8.40             mime_0.12               modelr_0.1.8           
  munsell_0.5.0           nlme_3.1.158            openssl_2.0.2          
  osmdata_0.1.10          pacman_0.5.1            paint_0.1.5            
  pillar_1.7.0            pkgconfig_2.0.3         plyr_1.8.7             
  png_0.1-7               prettyunits_1.1.1       processx_3.6.1         
  progress_1.2.2          PROJ_0.4.0              proj4_1.0.11           
  promises_1.2.0.1        proxy_0.4-27            pryr_0.1.5             
  ps_1.7.1                purrr_0.3.4             R.cache_0.16.0         
  R.methodsS3_1.8.2       R.oo_1.25.0             R.utils_2.12.0         
  R6_2.5.1                rapidjsonr_1.2.0        rappdirs_0.3.3         
  raster_3.5-15           RColorBrewer_1.1.3      Rcpp_1.0.8.3           
  readr_2.1.2             readxl_1.4.0            rematch_1.0.1          
  rematch2_2.1.2          remotes_2.4.2           renv_0.15.5            
  reprex_2.0.1            reproj_0.4.2            RgoogleMaps_1.4.5.3    
  rjson_0.2.21            rlang_1.0.4             rmarkdown_2.14         
  rprojroot_2.0.3         rstudioapi_0.13         rvest_1.0.2            
  s2_1.0.7                sass_0.4.1              satellite_1.0.4        
  scales_1.2.0            selectr_0.4-2           servr_0.24             
  sf_1.0-7                sfheaders_0.4.0         sp_1.5-0               
  splines_4.2.1           stats_4.2.1             stats4_4.2.1           
  stringi_1.7.6           stringr_1.4.0           styler_1.7.0           
  svglite_2.1.0           sys_3.4                 systemfonts_1.0.4      
  terra_1.5-34            tibble_3.1.7            tidylog_1.0.2          
  tidyr_1.2.0             tidyselect_1.1.2        tidyverse_1.3.1        
  tinytex_0.40            tools_4.2.1             tzdb_0.3.0             
  units_0.8-0             utf8_1.2.2              utils_4.2.1            
  uuid_1.1.0              vctrs_0.4.1             viridis_0.6.2          
  viridisLite_0.4.0       vroom_1.5.7             webshot_0.5.3          
  withr_2.5.0             wk_0.6.0                xfun_0.31              
  xml2_1.3.3              yaml_2.3.5             </code></pre>
</div>
</div>
</details><div class="watermark">
<p>DRAFT</p>
</div>
</section></main><!-- /main column -->
&nbsp;
<hr>
<p style="text-align: center;">A work by <a href="https://github.com/Andrei-WongE/">Andrei Wong Espejo</a></p>
<p style="text-align: center;"><span style="color: #808080;"><em>my email</em></span></p>

<!-- Add actions -->
<p style="text-align: center;"><span style="color:#808080; font-size: 15px;"><em>
  Corrections: If you see mistakes or want to suggest changes, please 
  <a href="https://github.com/Andrei-WongE/Spatial_notes/issues/new">
  create an issue</a></em></span></p>



<!-- Add icon library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<!-- Add font awesome icons --><p style="text-align: center;">
    <a href="https://twitter.com/Andrei_WongE" class="fa fa-twitter"></a>
    <a href="https://www.linkedin.com/in/andreiwe/" class="fa fa-linkedin"></a>
    <a href="https://github.com/Andrei-WongE/" class="fa fa-github"></a>
</p>

&nbsp;

<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->



<script src="index_files/libs/quarto-html/zenscroll-min.js"></script>
</body></html>